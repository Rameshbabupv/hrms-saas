# HRMS SaaS Project - Claude Memory

## ğŸ¯ Project Overview

**Project Name:** HRMS SaaS Multi-Tenant Platform
**Type:** Full-stack multi-tenant HRMS application
**Tech Stack:** React + Spring Boot + GraphQL + Keycloak + PostgreSQL

---

## ğŸ—ï¸ Architecture Decisions

### **Multi-Tenancy Design**
- **Tenant Identifier:** 12-character NanoID (lowercase alphanumeric)
  - Example: `a3b9c8d2e1f4`
  - Character set: `0-9a-z` (36 characters)
  - Generated by: Spring Boot backend using jnanoid library
- **Single ID Strategy:** `tenant_id` only (NOT separate company_id)
- **Storage:**
  - PostgreSQL: `company_master.tenant_id VARCHAR(21)` (primary key)
  - Keycloak: User attribute `tenant_id`
  - JWT Token: Claim `tenant_id`

### **Security Architecture**
- **Authentication:** Keycloak OAuth2/OIDC
- **Authorization:** JWT tokens with custom claims
- **Data Isolation:** PostgreSQL Row-Level Security (RLS)
- **API Security:**
  - REST endpoints for auth operations (public)
  - GraphQL endpoints for business operations (protected with JWT)

### **API Design**
- **REST API:** Authentication operations only
  - `POST /api/v1/auth/signup` - Customer signup
  - `POST /api/v1/auth/resend-verification` - Resend email
  - `GET /api/v1/auth/check-email` - Check availability
- **GraphQL API:** All business operations
  - Queries: employees, departments, company info
  - Mutations: create, update, delete operations
  - Endpoint: `POST /graphql`

### **Rollback Strategy**
- **Approach:** Partial rollback with retry (NOT full rollback)
- **Rationale:** Better UX, allows retry without re-entering data
- **Implementation:**
  1. Company creation committed immediately
  2. Keycloak failure â†’ Mark company as "PENDING_KEYCLOAK_SETUP", allow retry
  3. Email failure â†’ Keep user, allow manual resend

---

## ğŸ‘¤ User Information

**User Role:** React Developer (frontend focus)
**Team:** Working with Spring Boot backend developer(s)
**Expertise:** React, TypeScript, frontend development
**Backend Knowledge:** Basic understanding, needs detailed documentation

---

## ğŸ“ Project Structure

```
/Users/rameshbabu/data/projects/systech/hrms-saas/
â”œâ”€â”€ reactapp/                    # React frontend (COMPLETED)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ SignUp.tsx       # Customer signup form
â”‚   â”‚   â”‚   â”œâ”€â”€ EmailVerification.tsx
â”‚   â”‚   â”‚   â””â”€â”€ UserRegistration.tsx  # Internal user creation
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ keycloak.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ keycloak-admin.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ signup.service.ts
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ passwordValidator.ts
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.types.ts
â”‚   â”‚   â”‚   â””â”€â”€ signup.types.ts
â”‚   â”‚   â””â”€â”€ contexts/
â”‚   â”‚       â””â”€â”€ AuthContext.tsx
â”‚   â””â”€â”€ docs/                    # Documentation (COMPLETED)
â”‚       â”œâ”€â”€ README_SPRINGBOOT_DOCS.md      # Master index
â”‚       â”œâ”€â”€ SPRINGBOOT_QUICK_START.md       # 5-min setup
â”‚       â”œâ”€â”€ SPRINGBOOT_ARCHITECTURE.md      # Architecture
â”‚       â”œâ”€â”€ SPRINGBOOT_IMPLEMENTATION_GUIDE.md
â”‚       â”œâ”€â”€ SPRINGBOOT_REST_API.md
â”‚       â”œâ”€â”€ SPRINGBOOT_GRAPHQL.md
â”‚       â””â”€â”€ SPRINGBOOT_DOCKER_DEPLOYMENT.md
â””â”€â”€ nexus/simple-webapp/         # Reference Keycloak integration
```

---

## âœ… Completed Work

### **React Frontend (Completed)**
1. âœ… User signup form with password strength validator
2. âœ… Email verification flow
3. âœ… Keycloak SSO integration
4. âœ… Multi-tenant context management
5. âœ… Protected routes with JWT
6. âœ… Sign-up service for API calls
7. âœ… Password validation utilities

**Key Features:**
- Real-time password strength indicator (Weak â†’ Excellent)
- Email validation with typo detection
- Company name validation
- Loading states and error handling
- Responsive design with gradient purple theme

### **Spring Boot Documentation (Completed)**
1. âœ… Complete architecture documentation
2. âœ… Database schema with RLS policies
3. âœ… REST API implementation guide
4. âœ… GraphQL schema and resolvers
5. âœ… Security configuration (JWT, OAuth2, RLS)
6. âœ… Keycloak Admin API integration
7. âœ… Docker Compose setup
8. âœ… NanoID generator implementation
9. âœ… Testing and deployment guides

---

## ğŸ”‘ Critical Configuration

### **Environment Variables**
```env
# React App (.env)
REACT_APP_KEYCLOAK_URL=http://localhost:8090
REACT_APP_KEYCLOAK_REALM=hrms-saas
REACT_APP_KEYCLOAK_CLIENT=hrms-web-app
REACT_APP_API_URL=http://localhost:8081

# Spring Boot (application.yml)
spring.datasource.url=jdbc:postgresql://localhost:5432/hrms_saas_db
keycloak.server-url=http://localhost:8090
keycloak.realm=hrms-saas
```

### **Keycloak Configuration**
- **Realm:** hrms-saas
- **Client:** hrms-web-app (public client)
- **Client Mappers:** (CRITICAL)
  - `tenant_id` â†’ User Attribute â†’ `tenant_id`
  - `user_type` â†’ User Attribute â†’ `user_type`
  - `company_name` â†’ User Attribute â†’ `company_name`

### **JWT Token Claims**
```json
{
  "tenant_id": "a3b9c8d2e1f4",
  "user_type": "company_admin",
  "company_name": "Systech",
  "email": "babu@systech.com"
}
```

---

## ğŸ§ª Testing Credentials

### **Test User (Created via React App)**
```
Email: babu@systech.com
Password: Systech@Pass2024!
Company: Systech
Tenant ID: (auto-generated 12-char NanoID)
```

### **Service Credentials**
```
Keycloak Admin: admin / admin
PostgreSQL: hrms_user / hrms_password
```

---

## ğŸ”„ Request Flow

### **Sign-Up Flow**
1. User fills form in React app
2. React calls `POST /api/v1/auth/signup`
3. Spring Boot generates NanoID tenant_id
4. Creates `company_master` record in PostgreSQL
5. Creates Keycloak user with `tenant_id` attribute
6. Sends verification email via Keycloak
7. Returns `{ tenantId, userId, requiresEmailVerification: true }`

### **Login Flow**
1. User clicks "Sign In with Keycloak"
2. Redirects to Keycloak login page
3. User enters credentials
4. Keycloak validates and returns JWT
5. JWT contains `tenant_id` claim from user attributes
6. React stores token and extracts user info
7. Protected routes require valid JWT

### **GraphQL Request Flow**
1. React sends GraphQL query with JWT in Authorization header
2. Spring Security validates JWT signature
3. TenantFilter extracts `tenant_id` from JWT
4. Sets PostgreSQL session: `SET app.current_tenant = 'a3b9c8d2e1f4'`
5. Query executes with RLS policy filtering
6. Returns only tenant's data

---

## ğŸ“Š Database Schema

### **Key Tables**
```sql
-- Company Master (Tenant)
company_master (
  tenant_id VARCHAR(21) PRIMARY KEY,  -- NanoID
  company_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  status VARCHAR(20),  -- PENDING_ACTIVATION, ACTIVE, SUSPENDED
  ...
)

-- Employees (Multi-Tenant)
employees (
  id UUID PRIMARY KEY,
  tenant_id VARCHAR(21) REFERENCES company_master(tenant_id),
  employee_code VARCHAR(50),
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  email VARCHAR(255),
  ...
)

-- RLS Policy
CREATE POLICY tenant_isolation_policy ON employees
  USING (tenant_id = current_setting('app.current_tenant')::VARCHAR);
```

---

## ğŸ¨ UI/UX Decisions

### **Design Theme**
- **Colors:** Purple gradient (`#667eea` â†’ `#764ba2`)
- **Style:** Modern, clean, card-based layout
- **Responsive:** Mobile-friendly forms

### **Password Strength Indicator**
- **Levels:** Weak (red) â†’ Fair (orange) â†’ Good (yellow) â†’ Strong (light green) â†’ Excellent (dark green)
- **Requirements:** 8+ chars, uppercase, lowercase, number, special char
- **Feedback:** Real-time validation messages

### **Error Handling**
- Clear error messages in red boxes
- Field-level validation
- Network error handling
- User-friendly messages (no technical jargon)

---

## ğŸš€ Deployment Architecture

### **Local Development (Current)**
- React: `http://localhost:3000`
- Spring Boot: `http://localhost:8081`
- Keycloak: `http://localhost:8090`
- PostgreSQL: `localhost:5432`

### **Production (Planned)**
- Frontend: CDN or static hosting
- Backend: Kubernetes/Docker
- Keycloak: Clustered
- PostgreSQL: Managed service with replication

---

## ğŸ› Known Issues & Solutions

### **Issue: Keycloak Not Initialized**
**Solution:** Enhanced error handling in keycloak.service.ts with auto-retry

### **Issue: TypeScript Version Conflict**
**Solution:** Downgraded from 5.7.3 to 4.9.5 for react-scripts compatibility

### **Issue: Password Does Not Meet Requirements**
**Cause:** Password missing uppercase letter or has sequential characters
**Solution:** Use password generator: `Systech@Pass2024!` format

---

## ğŸ“ Next Steps

### **Pending Tasks**
1. Backend implementation by Spring Boot developer
2. Integration testing (React + Spring Boot)
3. Email service configuration (SMTP)
4. Production Keycloak configuration
5. GraphQL client integration in React
6. Department and employee management features

### **Future Enhancements**
- Two-factor authentication
- Role-based UI rendering
- Advanced reporting
- File upload (employee documents)
- Real-time notifications
- Mobile app (React Native)

---

## ğŸ“š Important Notes

### **Security Considerations**
- âš ï¸ NEVER send `tenant_id` in request body or URL
- âš ï¸ ALWAYS extract `tenant_id` from JWT (server-side)
- âš ï¸ Backend must validate JWT signature
- âš ï¸ RLS is the final layer of defense

### **Multi-Tenant Best Practices**
- Each query automatically filtered by tenant_id via RLS
- No need to add WHERE tenant_id = ? in queries
- RLS policies enforce data isolation at database level
- ThreadLocal stores tenant context per request

### **Development Workflow**
1. Make changes in React app
2. Test locally with Keycloak
3. Document API changes
4. Communicate with backend developer
5. Integration testing
6. Deployment

---

## ğŸ”— Quick Links

### **Documentation**
- Start: `docs/README_SPRINGBOOT_DOCS.md`
- Quick Start: `docs/SPRINGBOOT_QUICK_START.md`
- Architecture: `docs/SPRINGBOOT_ARCHITECTURE.md`

### **Code Locations**
- Signup Form: `src/components/auth/SignUp.tsx`
- Password Validator: `src/utils/passwordValidator.ts`
- Auth Context: `src/contexts/AuthContext.tsx`
- Keycloak Service: `src/services/keycloak.service.ts`

---

## ğŸ’¡ Key Insights from Conversations

### **User Preferences**
- Prefers GraphQL for business operations
- Wants secure multi-tenant architecture
- Needs short, readable tenant IDs (NanoID)
- Values comprehensive documentation
- Focuses on security (RLS, JWT validation)

### **Technical Decisions Made**
1. NanoID over UUID for tenant_id (shorter, user-friendly)
2. Single tenant_id (not dual company_id/tenant_id)
3. Partial rollback strategy (better UX)
4. REST for auth, GraphQL for business logic
5. PostgreSQL RLS for data isolation

### **Documentation Approach**
- Created 7 comprehensive documents
- Includes code examples, schemas, configurations
- Step-by-step guides for setup and testing
- Production deployment checklists
- Troubleshooting sections

---

## ğŸ“ Communication Style

### **When Responding:**
- Be concise and technical
- Provide code examples
- Explain security implications
- Ask clarifying questions when needed
- Think through architecture implications

### **User Expects:**
- Professional, objective responses
- Security-first mindset
- Detailed documentation
- Working code examples
- No emojis unless requested (except in docs for readability)

---

## âœ… Session Summary

**Date:** 2025-01-30
**Accomplishments:**
1. âœ… Implemented complete React signup flow
2. âœ… Created password strength validator
3. âœ… Tested signup with Chrome DevTools MCP
4. âœ… Generated strong test password: `Systech@Pass2024!`
5. âœ… Created 7 comprehensive Spring Boot documentation files
6. âœ… Documented architecture with NanoID multi-tenancy
7. âœ… Provided Docker Compose and deployment guides

**Status:** Frontend complete, documentation complete, ready for backend development

**Next Session:** Backend implementation or additional React features
